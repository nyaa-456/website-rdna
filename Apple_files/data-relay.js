"use strict";function _defineProperty(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _slicedToArray(e,t){return _arrayWithHoles(e)||_iterableToArrayLimit(e,t)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}function _iterableToArrayLimit(e,t){var r=[],i=!0,a=!1,o=void 0;try{for(var n,s=e[Symbol.iterator]();!(i=(n=s.next()).done)&&(r.push(n.value),!t||r.length!==t);i=!0);}catch(e){a=!0,o=e}finally{try{i||null==s.return||s.return()}finally{if(a)throw o}}return r}function _arrayWithHoles(e){if(Array.isArray(e))return e}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function _createClass(e,t,r){return t&&_defineProperties(e.prototype,t),r&&_defineProperties(e,r),e}function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}require=function(){return function e(t,r,i){function a(n,s){if(!r[n]){if(!t[n]){var l="function"==typeof require&&require;if(!s&&l)return l(n,!0);if(o)return o(n,!0);var c=new Error("Cannot find module '"+n+"'");throw c.code="MODULE_NOT_FOUND",c}var u=r[n]={exports:{}};t[n][0].call(u.exports,function(e){return a(t[n][1][e]||e)},u,u.exports,e,t,r,i)}return r[n].exports}for(var o="function"==typeof require&&require,n=0;n<i.length;n++)a(i[n]);return a}}()({1:[function(e,t,r){var i=!1,a=window||self;try{i=!!a.localStorage.getItem("f7c9180f-5c45-47b4-8de4-428015f096c0")}catch(e){}t.exports=i},{}],2:[function(e,t,r){var i=e("../enabled");t.exports=function(e){return function(){if(i&&"object"===_typeof(window.console)&&"function"==typeof console[e])return console[e].apply(console,Array.prototype.slice.call(arguments,0))}}},{"../enabled":1}],3:[function(e,t,r){t.exports=e("./internal/expose")("log")},{"./internal/expose":2}],"@marcom/data-relay":[function(e,t,r){var i,a=e("@marcom/ac-console/log");try{i=e("@marcom/ac-analytics")}catch(e){a(e)}var o={properties:{absoluteUrlRegex:new RegExp("^(?:[a-z]+:)+//","i"),analyticsTitle:"data relayed",cidQueryParam:"cid",cookieDomain:".apple.com",cookieMaxKeyLength:5,cookieName:"aw_rid",cookieValueSeparator:"|",cookieValueEntrySeparator:":",customAnalyticsAttribute:"",dataMaxLength:100,deferNavigationTimeout:400,interactionEvent:"mouseup",internalLinkAttribute:"data-analytics-intrapage-link",parseRelativeUrlRegex:new RegExp("^([./]*)(.+)"),prefixAllowedCharacters:/^[A-Za-z0-9_]+$/,prefixMaxLength:3,relayButtonUrlAttribute:"data-url",ridQueryParam:"rid",ridRelayAttribute:"data-rid-relay",ridRelaySelector:"[data-rid-relay]",ridStoreAttribute:"data-rid-store",ridStoreSelector:"[data-rid-store]",sridQueryParam:"srid",sridStorageKey:"aw_srid",ridPrefixSeparator:"-",trackingDataSeparator:"|",trackingProperty:"eVar17",urlFormatHostName:"https://apple.com/",urlSeparator:",",valueAllowedCharacters:/^[A-Za-z0-9-_%]+$/},options:{automaticMode:!0,canDeferNavigation:!0,trackCid:!1,useJsonStorageFormat:!1,useSecureCookie:!0},passiveTracking:{overwriteStorageItem:!1,overwriteStorageItemValues:!0,overwriteAppMeasurementValues:!0,overwriteAppMeasurementEvents:!0}},n=function(){function e(t){_classCallCheck(this,e),this._isSupported()&&this._initialize(t)}return _createClass(e,[{key:"_isSupported",value:function(){if(!(window&&document&&document.documentElement&&Array.prototype.includes))return!1;try{var e=new window.URL("x","http://w");return e.pathname="y%20z","http://w/y%20z"===e.href&&void 0!==e.searchParams}catch(e){return!1}}},{key:"_initialize",value:function(e){if(this.options=o.options,this.properties=o.properties,this.passiveTracking=o.passiveTracking,this.analytics=i,this._applyConfigurations(e),this.options.automaticMode){var t=this.getRidFromUrl(window.location.href),r=this.getSridFromUrl(window.location.href);this.storeRid(t),this.storeSrid(r),this._setupEventHandlers()}}},{key:"_applyConfigurations",value:function(e){var t=this;if(e){var r=Object.keys(o);Object.keys(e).forEach(function(i){r.includes(i)&&(t[i]=Object.assign(t[i],e[i]))})}}},{key:"_setupEventHandlers",value:function(){this._handleClick=this._handleClick.bind(this),document.documentElement.addEventListener(this.properties.interactionEvent,this._handleClick)}},{key:"_handleClick",value:function(e){var t=this._ancestor(e.target,"".concat(this.properties.ridRelaySelector,", ").concat(this.properties.ridStoreSelector));a("Data Relay - click occurred - looking for ancestor that has data-rid-relay or data-rid-store"),t&&(t.getAttribute(this.properties.ridRelayAttribute)?(a("Data Relay - an element with data-rid-relay was clicked"),this._handleRidRelay(e,t)):t.getAttribute(this.properties.ridStoreAttribute)&&(a("Data Relay - an element with data-rid-store was clicked"),this._handleRidStore(e,t)))}},{key:"storeRid",value:function(e){if(e){var t=this.getRidFromCookie();t?(a("Data Relay - cookie was already there, combining the new data with the current cookie data"),a("Data Relay - current data stored in cookie",t),a("Data Relay - the rid that is currently in the URL that is overwriting the current rid",e),a("Data Relay - the combined value of the old and new rid data"),this.writeCookieFromObj(this._prepareCookieData(e,t))):(a("Data Relay - cookie was not already there - just created now"),a('Data Relay - wrote the following string to the cookie:"',JSON.stringify(e)+'"'),this.writeCookieFromObj(this._prepareCookieData(e)))}}},{key:"storeSrid",value:function(e){if(e){var t=this.getSridFromSessionStorage();this._deleteInvalidValues(e,!1),t?(a("Data Relay - session storage was already there, combining the new data with the current session storage data"),a("Data Relay - current data stored in session storage",t),a("Data Relay - the srid that is currently in the URL that is overwriting the current srid",e),a("Data Relay - the combined value of the old and new srid data"),this.writeSridToSessionStorage(Object.assign({},t,e))):(a("Data Relay - session storage was not already there - just created now"),a('Data Relay - wrote the following string to the session storage:"',JSON.stringify(e)+'"'),this.writeSridToSessionStorage(e))}}},{key:"_prepareCookieData",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};this._deleteInvalidValues(e,!0);var r=Object.assign({},t,e),i=Object.keys(r),a=i.length-this.properties.cookieMaxKeyLength;if(a<=0)return r;for(var o=Object.keys(e),n=i.filter(function(e){return!o.includes(e)});a>0;){var s=void 0;s=n.length?n:o,delete r[this._getRandomArrayItem(s)],a--}return r}},{key:"writeCookieFromObj",value:function(e){var t="";return this.options.useSecureCookie&&(t=" secure;"),!this.options.trackCid&&e.cid&&delete e.cid,this._deleteInvalidValues(e,!0),!this._isEmpty(e)&&(!!(e=this._formatCookieData(e))&&(document.cookie="".concat(this.properties.cookieName,"=").concat(e,"; path=/; domain=").concat(this.properties.cookieDomain,";").concat(t),e))}},{key:"writeSridToSessionStorage",value:function(e){return!this._isEmpty(e)&&(e=encodeURIComponent(JSON.stringify(e)),window.sessionStorage.setItem(this.properties.sridStorageKey,e),e)}},{key:"_formatCookieData",value:function(e){return e?this.options.useJsonStorageFormat?encodeURIComponent(JSON.stringify(e)):this._createSimpleFormatCookieData(e):null}},{key:"_createSimpleFormatCookieData",value:function(e){var t=this,r="";return Object.keys(e).forEach(function(i){r+="".concat(i).concat(t.properties.cookieValueEntrySeparator).concat(encodeURIComponent(e[i])).concat(t.properties.cookieValueSeparator)}),r=r.substring(0,r.length-this.properties.cookieValueSeparator.length),encodeURIComponent(r)}},{key:"_handleRidRelay",value:function(e,t){var r=this.getRidMappingFromEl(t);if(r){var i,o=this.getRidFromCookie(),n=this.getSridFromSessionStorage(),s=Object.assign({},o,n);this._isEmpty(s)?a("Data Relay - no cookie or session data applied, there was no data stored"):i=this.relayDataToElement(t,r,s),i||(i=this.getTrackingDataForEl(t,r)),i&&this._trackAnalyticsData(t,i,r,e)}else a("Data Relay - no action taken, there was no proper data mapping")}},{key:"_handleRidStore",value:function(e,t){var r=this.getRidStorageDataFromEl(t);r?(a("Data Relay - rid storage data found in element - attempting to store"),this.storeRid(r)):a("Data Relay - no action taken, there was no proper data in the rid store attribute")}},{key:"_trackAnalyticsData",value:function(e,t,r,i){if(a("Data Relay - analytics tracking - "+this.properties.trackingProperty+' should be tracked with the value "',t+'"'),this.analytics){var o=this._createTrackingData(e,t,r);if(e.getAttribute("data-analytics-click")||e.hasAttribute("data-analytics-exit-link")||this.properties.customAnalyticsAttribute&&e.hasAttribute(this.properties.customAnalyticsAttribute))return delete o.title,void this.analytics.passiveTracker(o,this.passiveTracking);this.options.canDeferNavigation&&"A"===e.tagName&&!this._isIntraPageLink(e)&&(i.preventDefault(),this.timeout=setTimeout(function(){window.location=e.href},this.properties.deferNavigationTimeout)),this.analytics.track(o)}}},{key:"_createTrackingData",value:function(e,t,r){var i={};e&&e.hasAttribute("data-rid-options")&&(i=JSON.parse(e.getAttribute("data-rid-options")));var a=this._buildEventsString(r,i),o={title:i.analyticsTitle||this.properties.analyticsTitle,events:a};return o[i.trackingProperty||this.properties.trackingProperty]=t,o}},{key:"_buildEventsString",value:function(e,t){var r="";return Object.keys(e).forEach(function(e){t&&t.eventTracking&&t.eventTracking[e]?r+="event".concat(t.eventTracking[e],","):"cid"!==e&&(r+="event".concat(e,","))}),r=r.substring(0,r.length-1)}},{key:"getTrackingDataForEl",value:function(e,t){var r,i=this,o=[];e.href?r="href":e.getAttribute(this.properties.relayButtonUrlAttribute)&&(r=this.properties.relayButtonUrlAttribute);var n=Object.keys(t),s=e.getAttribute(r),l=this.getQueryString(this._formatUrl(s).url);return n.forEach(function(e){var r=[];if("string"==typeof t[e]&&(t[e]=[t[e]]),t[e].forEach(function(e){var t=l[e];if(t&&i.properties.valueAllowedCharacters.test(t)){if(e===i.properties.cidQueryParam&&null!==t){if(!i.options.trackCid)return;t="".concat(i.properties.cidQueryParam,"-").concat(t)}t&&r.push(t)}}),r.length<1)a("Data Relay - there was no data available in the elements url that corresponds to the rid to query param mapping, so this data will not be tracked on "+i.properties.trackingProperty);else{var n=new Set(r);Array.from(n).forEach(function(e){o.push(e)})}}),a('Data Relay - built the data for a link that had no data relayed to it, the current value of "'+o+'" will be tracked on '+this.properties.trackingProperty),o.join(this.properties.trackingDataSeparator)}},{key:"relayDataToElement",value:function(e,t,r){var i=this,o=[],n=[];e.href&&o.push("href"),e.getAttribute(this.properties.relayButtonUrlAttribute)&&o.push(this.properties.relayButtonUrlAttribute);var s=Object.keys(t);return o.forEach(function(o){var l=i._formatUrl(e.getAttribute(o)),c=new URL(l.url);s.forEach(function(s){if(s+""in r){if(s===i.properties.cidQueryParam){if(!i.options.trackCid)return;n.push("".concat(s,"-").concat(r[s]))}else n.push(r[s]);"string"==typeof t[s]&&(t[s]=[t[s]]),t[s].forEach(function(e){c.searchParams.set(e,r[s])});var u=c.toString();l.relative&&(u=u.replace(i.properties.urlFormatHostName,l.original)),e.setAttribute(o,decodeURIComponent(u)),a('Data Relay - the data-url of the element had the query string named "'+t[s]+'" and the value of it was replaced with '+r[s]+' rid - "'+s+'"')}})}),n.join(this.properties.trackingDataSeparator)}},{key:"getSridFromSessionStorage",value:function(){var e=window.sessionStorage.getItem(this.properties.sridStorageKey);return e?(e=JSON.parse(decodeURIComponent(e)),!this._isEmpty(e)&&e):null}},{key:"getRidFromCookie",value:function(){var e=this,t=document.cookie,r=(t=t.split("; ")).find(function(t){return 0===t.indexOf(e.properties.cookieName)});return r?(r=this._readCookie(r.split("=")[1]),this._deleteInvalidValues(r,!0),!this._isEmpty(r)&&r):null}},{key:"_readCookie",value:function(e){return e?this.options.useJsonStorageFormat?JSON.parse(decodeURIComponent(e)):this._readSimpleFormatCookie(e):{}}},{key:"_readSimpleFormatCookie",value:function(e){var t=this;return(e=decodeURIComponent(e)).split(this.properties.cookieValueSeparator).reduce(function(e,r){var i=_slicedToArray(r.split(t.properties.cookieValueEntrySeparator),2),a=i[0],o=i[1];return e[a]=decodeURIComponent(o),e},{})}},{key:"destroy",value:function(){document.documentElement.removeEventListener(this.properties.interactionEvent,this._handleClick)}},{key:"getRidMappingFromEl",value:function(e){return JSON.parse(e.getAttribute(this.properties.ridRelayAttribute))}},{key:"getRidStorageDataFromEl",value:function(e){var t=JSON.parse(e.getAttribute(this.properties.ridStoreAttribute));return this._deleteInvalidValues(t,!0),!this._isEmpty(t)&&t}},{key:"getRidFromUrl",value:function(e){var t=this.getQueryString(e),r=t[this.properties.ridQueryParam],i={};if(r&&(i=this._parseRidStringData(r)),this.options.trackCid){var a,o=t[this.properties.cidQueryParam];o&&(a=this._parseCidStringData(o)),a&&Object.assign(i,a)}return this._isEmpty(i)&&(i=null),i}},{key:"getSridFromUrl",value:function(e){var t=this.getQueryString(e)[this.properties.sridQueryParam],r={};return t&&(r=this._parseRidStringData(t)),this._isEmpty(r)&&(r=null),r}},{key:"getRelayData",value:function(e,t,r,i){var a=this;if(!e)return null;void 0===r&&(r=!0),void 0===i&&(i=!1);var o=this.getRidFromCookie();if(!o&&!t)return null;var n=new Set,s=new Set;Array.isArray(e)||(e=[e]),Array.isArray(t)||(t=[t]),e.forEach(function(e,r){if(!(e.length>a.properties.prefixMaxLength||!a.properties.prefixAllowedCharacters.test(e))){if(!o||void 0===o[e]||a.properties.dataMaxLength<o[e].length||!a.properties.valueAllowedCharacters.test(o[e])){if(!t[r]||a.properties.dataMaxLength<t[r].length||!a.properties.valueAllowedCharacters.test(t[r]))return;n.add(t[r])}else n.add(o[e]);s.add("event".concat(e))}}),n=this._listToString(n);var l=_defineProperty({events:s=this._listToString(s)},this.properties.trackingProperty,n);return this.analytics&&r&&t&&l[this.properties.trackingProperty]&&l.events&&(i?this.analytics.passiveTracker(l,this.passiveTracking):(l.title=this.properties.analyticsTitle,this.analytics.track(l))),{data:n,trackingData:l}}},{key:"get",value:function(e){var t=this.getRidFromCookie();return t&&void 0!==t[e]?t[e]:null}},{key:"set",value:function(e,t){return e&&"string"==typeof e&&t&&"string"==typeof t?this.storeRid(_defineProperty({},e,t)):null}},{key:"_listToString",value:function(e){var t="";return e.forEach(function(e){t+="".concat(e,",")}),t.substring(0,t.length-1)}},{key:"getQueryString",value:function(e){var t={};return e.substring(e.indexOf("?")+1).split("&").forEach(function(e){var r=_slicedToArray(e.split("="),2),i=r[0],a=r[1];t[i]=a}),t}},{key:"_deleteInvalidValues",value:function(e){var t=this,r=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];Object.keys(e).forEach(function(i){(r&&t.properties.dataMaxLength<e[i].length||t.properties.prefixMaxLength<i.length||!t.properties.valueAllowedCharacters.test(e[i])||!t.properties.prefixAllowedCharacters.test(i))&&delete e[i]})}},{key:"_isEmpty",value:function(e){return 0===Object.keys(e).length}},{key:"_parseRidStringData",value:function(e){var t,r=this;try{t=decodeURIComponent(e)}catch(e){a(e)}if(!t)return{};var i={};return t.split(this.properties.urlSeparator).forEach(function(e){var t=e.split(r.properties.ridPrefixSeparator),a=t.shift();if(a&&a.length<=r.properties.prefixMaxLength&&r.properties.prefixAllowedCharacters.test(a)){var o=t.join(r.properties.ridPrefixSeparator);o=encodeURIComponent(o),r.properties.valueAllowedCharacters.test(o)&&(i[a]=o)}}),i}},{key:"_formatUrl",value:function(e){var t={relative:!1,original:!1,url:null};if(this.properties.absoluteUrlRegex.test(e))return t.url=e,t;var r=this.properties.parseRelativeUrlRegex.exec(e);return r.length&&r[r.length-1]?(t.relative=!0,t.original=r[1],t.url=this.properties.urlFormatHostName+r[r.length-1],t):null}},{key:"_parseCidStringData",value:function(e){var t={};return t[this.properties.cidQueryParam]=e,t}},{key:"_ancestor",value:function(e,t){if(e.matches(t))return e;for(;(e=e.parentNode)&&e.nodeType===Node.ELEMENT_NODE;){if(!t||e.matches(t))return e;if(e===document.documentElement)break}return null}},{key:"_getRandomArrayItem",value:function(e){return e.splice(Math.floor(Math.random()*e.length),1)}},{key:"_isIntraPageLink",value:function(e){var t=e.getAttribute("href");return!(null!==t&&"#"!==t.charAt(0)&&0!==t.indexOf("javascript:")&&0!==t.indexOf("mailto:")&&0!==t.indexOf("tel:")&&!e.hasAttribute(this.properties.internalLinkAttribute))}}]),e}();t.exports=n},{"@marcom/ac-analytics":"@marcom/ac-analytics","@marcom/ac-console/log":3}]},{},[]);